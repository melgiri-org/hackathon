<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Member Dashboard | Cooperative Ledger</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --space-indigo: #22223bff;
      --dusty-grape: #4a4e69ff;
      --lilac-ash: #9a8c98ff;
      --almond-silk: #c9ada7ff;
      --parchment: #f2e9e4ff;

      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      --shadow-lg: 0 14px 40px rgba(34,34,59,0.14);
      --shadow-sm: 0 6px 18px rgba(34,34,59,0.06);
      --muted: var(--lilac-ash);
    }

    /* Base layout */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:
      radial-gradient(700px 300px at 6% 10%, rgba(74,78,105,0.04), transparent),
      linear-gradient(180deg, var(--parchment) 0%, #fff 60%);
      font-family:"Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      color:var(--space-indigo);
    }
    body{padding:28px 20px}

    /* Top wave */
    .top-wave {
      position: absolute;
      left: 0; right: 0; top: -20px;
      pointer-events: none; z-index: 1; opacity: 0.08;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
      margin-bottom:18px;
      position: relative; z-index: 6;
    }
    h1{margin:0; font-size:20px; color:var(--space-indigo); letter-spacing:0.2px}
    .muted{color:var(--muted)}

    /* Container */
    .container{
      position: relative; z-index: 6;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:20px;
      max-width:1200px;
      margin: 0 auto;
      animation: fadeInUp .6s ease both;
    }

    /* Card */
    .card{
      background: var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow: var(--shadow-sm);
      border:1px solid rgba(34,34,59,0.04);
    }

    .metric{
      padding:14px;border-radius:10px;
      background:linear-gradient(180deg, rgba(249,246,243,0.9), rgba(255,255,255,0.96));
      font-weight:700;color:var(--space-indigo);font-size:14px;
      box-shadow: 0 6px 14px rgba(74,78,105,0.04);
      margin-bottom:10px;
    }

    .btn{
      background:linear-gradient(135deg,var(--space-indigo),var(--dusty-grape));
      color:var(--parchment);padding:9px 14px;border-radius:10px;border:none;cursor:pointer;
      box-shadow: 0 10px 28px rgba(34,34,59,0.12);
      transition: transform .12s ease, box-shadow .12s ease;
      font-weight:600;
    }
    .btn:hover{ transform: translateY(-3px); box-shadow: 0 16px 40px rgba(34,34,59,0.16); }

    .btn-outline{
      background:transparent;border:1px solid rgba(34,34,59,0.06);
      color:var(--muted);padding:9px 12px;border-radius:10px;cursor:pointer;
    }
    .btn-outline:hover{ background: rgba(34,34,59,0.02); transform: translateY(-2px); }

    .muted{color:var(--muted);font-size:13px}

    input,textarea,select{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(154,140,152,0.14);
      margin-top:8px;background:rgba(255,255,255,0.96);font-size:14px;color:var(--space-indigo);
      box-shadow: 0 4px 12px rgba(34,34,59,0.04);
      transition: border-color .14s ease, box-shadow .14s ease, transform .14s ease;
    }
    input::placeholder, textarea::placeholder { color: var(--lilac-ash); opacity: 0.95; }
    input:focus, textarea:focus, select:focus {
      border-color: var(--dusty-grape);
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
      outline: none;
    }

    label{font-size:13px;color:var(--space-indigo);display:block;margin-top:8px}

    .list{max-height:520px;overflow:auto;margin-top:8px;padding-right:6px}
    .tx-row{padding:12px;border-bottom:1px solid rgba(14,20,30,0.04)}
    .tx-row .meta{color:var(--muted);font-size:13px;margin-top:8px}
    .block-box{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      background:linear-gradient(180deg,#0b1220,#0f172a);color:#fff;padding:12px;border-radius:10px;margin-bottom:12px;word-break:break-all;
      box-shadow: 0 8px 26px rgba(15,23,42,0.18);
    }

    .note{color:var(--muted);font-size:13px;margin-top:8px}
    .form-actions{display:flex;gap:8px;margin-top:8px}
    .small-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:13px;color:#065f46;margin-top:8px}

    .card h3 { margin:0 0 8px 0; color:var(--space-indigo); font-size:16px; }

    .card-footer {
      margin-top:12px; padding-top:10px; border-top:1px solid rgba(34,34,59,0.03);
      color:var(--muted); font-size:13px;
    }

    /* animations */
    @keyframes fadeInUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }

    @media(max-width:980px){
      .container{grid-template-columns:1fr; padding-bottom:28px}
    }
  </style>
</head>
<body>

  <!-- decorative top wave -->
  <svg class="top-wave" width="1600" height="220" viewBox="0 0 1600 220" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M0 120 C200 20, 400 220, 800 120 C1200 20, 1400 220, 1600 120 L1600 0 L0 0 Z" fill="url(#g1)" />
    <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#4a4e69" stop-opacity="0.10"/><stop offset="1" stop-color="#9a8c98" stop-opacity="0.05"/></linearGradient></defs>
  </svg>

<header>
  <div>
    <h1>Cooperative Ledger — Member</h1>
    <div class="muted">View public transactions · Deposit & withdraw · Request private loans</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <!-- LEFT: Quick info + Deposit/Withdraw + Loan Request -->
  <div>
    <div class="card" role="region" aria-label="Balances">
      <div class="metric" id="poolBalance">Pool Balance:  </div>
      <div class="metric" id="yourDeposited">Your Deposited: </div>
      <div class="note">You can deposit funds and withdraw up to 150% of your deposited amount. Exceeding that will be treated as a loan — please use the Loan Request form.</div>
    </div>

    <div class="card" style="margin-top:12px;" aria-label="Deposit funds">
      <h3>Deposit Funds</h3>
      <label for="depositAmount">Amount (₹)</label>
      <input id="depositAmount" type="number" min="1" placeholder="Amount to deposit" />

      <div class="form-actions">
        <button class="btn" onclick="submitDeposit()">Deposit</button>
        <button class="btn-outline" onclick="clearDeposit()">Clear</button>
      </div>
      <div id="depositMessage" class="note"></div>
    </div>

    <div class="card" style="margin-top:12px;" aria-label="Withdraw funds">
      <h3>Withdraw Funds</h3>
      <label for="withdrawAmount">Amount (₹)</label>
      <input id="withdrawAmount" type="number" min="1" placeholder="Amount to withdraw" />

      <div class="form-actions">
        <button class="btn" onclick="submitWithdraw()">Withdraw</button>
        <button class="btn-outline" onclick="clearWithdraw()">Clear</button>
      </div>
      <div id="withdrawMessage" class="note"></div>
      <div id="withdrawHint" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px;" aria-label="Request loan">
      <h3>Request a Loan (Private)</h3>
      <label for="loanAmount">Amount (₹)</label>
      <input id="loanAmount" type="number" min="1" placeholder="Enter loan amount" />

      <label for="loanReason">Reason for loan (required)</label>
      <textarea id="loanReason" rows="4" placeholder="Describe why you need the loan (10+ chars)"></textarea>

      <label for="loanDocs">Supporting document (optional)</label>
      <input id="loanDocs" type="file" accept=".pdf,.jpg,.png" />

      <div class="form-actions">
        <button class="btn" onclick="submitLoan()">Submit Request</button>
        <button class="btn-outline" onclick="clearLoanForm()">Clear</button>
      </div>
      <div id="loanMessage" class="note" style="margin-top:8px"></div>
    </div>

    <div class="card-footer card" style="margin-top:12px">
      <div class="card-footer">Powered by Blockchain Trust • Demo v0.1</div>
    </div>
  </div>

  <!-- RIGHT: Transactions (public-only) -->
  <div>
    <div class="card" aria-label="Public transactions">
      <h3>Public Transaction Feed</h3>
      <div class="muted">This list shows only transactions that are public on the chain. Loan approvals and private loan details are not shown here.</div>

      <div style="margin-top:12px">
        <button class="btn-outline" onclick="refreshPublicTransactions()">Refresh</button>
      </div>

      <div id="txList" class="list" style="margin-top:12px" aria-live="polite">
        <!-- Transactions will render here from /chain/blocks (filtered) -->
      </div>
    </div>
  </div>
</div>



<script>
  // ---------------- Config endpoints ----------------
  const ENDPOINTS = {
    publicBlocks: '/chain/blocks',       // or '/chain/public_blocks'
    submitLoan: '/member/loan',
    dashboard: '/member/dashboard',      // optional: { deposited, poolBalance }
    deposit: 'http://<ip>/dep',
    withdraw: 'http://<ip>/wit'
  };

  // ---------------- State ----------------
  let poolBalance = 0;
  let yourDeposited = 0; // must be fetched from the backend (dashboard endpoint) after login

  function formatINR(n){ return "₹"+Number(n).toLocaleString("en-IN"); }
  function escapeHtml(str){ if(!str) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

  // ---------------- Fetch dashboard info (deposited amount & pool balance) ----------------
  async function fetchDashboard(){
    try {
      const res = await fetch(ENDPOINTS.dashboard, { credentials: 'include' });
      if(!res.ok) {
        // silently ignore; UI will continue to function with zeros
        return;
      }
      const data = await res.json();
      // Expecting { deposited: number, balance: number } or { yourDeposited, poolBalance }
      if(typeof data.deposited !== 'undefined') yourDeposited = Number(data.deposited);
      if(typeof data.yourDeposited !== 'undefined') yourDeposited = Number(data.yourDeposited);
      if(typeof data.balance !== 'undefined') poolBalance = Number(data.balance);
      if(typeof data.poolBalance !== 'undefined') poolBalance = Number(data.poolBalance);
      updateBalancesUI();
    } catch (e) {
      console.warn('dashboard fetch', e);
    }
  }

  function updateBalancesUI(){
    document.getElementById('poolBalance').innerText = 'Pool Balance: ' + formatINR(poolBalance);
    document.getElementById('yourDeposited').innerText = 'Your Deposited: ' + formatINR(yourDeposited);
    updateWithdrawHint();
  }

  function updateWithdrawHint(){
    const limit = computeWithdrawLimit();
    document.getElementById('withdrawHint').innerText = `Max withdraw allowed: ${formatINR(limit)} (150% of your deposited amount). If you need more, submit a loan request.`;
  }

  function computeWithdrawLimit(){
    // withdraw limit = yourDeposited + 0.5 * yourDeposited = 1.5 * yourDeposited
    return Math.floor(yourDeposited * 1.5);
  }

  // ---------------- Public blocks (filtered) ----------------
  async function fetchPublicBlocks(){
    try {
      const res = await fetch(ENDPOINTS.publicBlocks, { credentials: 'include' });
      if(!res.ok) throw new Error('Failed to fetch public blocks: ' + res.status);
      const data = await res.json();
      // Defensive: filter out loan-related blocks if included
      const filtered = data.filter(b => !isLoanBlock(b));
      return filtered;
    } catch (e) {
      console.warn(e);
      return [];
    }
  }

  function isLoanBlock(block){
    if(!block || !block.data) return false;
    const s = String(block.data).toLowerCase();
    const loanKeywords = ['loan', 'approve loan', 'approved loan', 'rejected loan', 'loan request'];
    return loanKeywords.some(k => s.includes(k));
  }

  async function refreshPublicTransactions(){
    const list = document.getElementById('txList');
    list.innerHTML = '<div class="muted" style="padding:12px">Loading public transactions…</div>';
    const blocks = await fetchPublicBlocks();

    if(!blocks || blocks.length === 0){
      list.innerHTML = '<div class="muted" style="padding:12px">No public transactions available.</div>';
      return;
    }

    list.innerHTML = '';
    blocks.slice().reverse().forEach(b=>{
      const row = document.createElement('div');
      row.className = 'tx-row';
      row.innerHTML = `<div style="font-weight:700">${escapeHtml(b.data)}</div>
                       <div class="meta">${new Date(b.timestamp).toLocaleString()} · Block #${b.index} · <span style="font-family:monospace">${b.hash}</span></div>`;
      list.appendChild(row);
    });
  }

  // ---------------- Deposit flow ----------------
  async function submitDeposit(){
    const amount = Number(document.getElementById('depositAmount').value || 0);
    const msg = document.getElementById('depositMessage');
    msg.innerText = '';

    if(!amount || amount <= 0){
      msg.innerText = 'Please enter a valid deposit amount.';
      return;
    }

    // Build form data (backend may expect JSON instead; change accordingly)
    const form = new FormData();
    form.append('amt', amount);
    form.append('user', 'hi');

    try {
      const res = await fetch(ENDPOINTS.deposit, {
        method: 'POST',
        credentials: 'include',
        body: form
      });

      if(!res.ok){
        const text = await res.text();
        msg.innerText = 'Deposit failed: ' + (text || res.status);
        return;
      }

      const data = await res.json();
      // Expect backend to return updated deposited amount and pool balance:
      // { ok:true, deposited: number, poolBalance: number, txId, status }
      if(typeof data.deposited !== 'undefined') yourDeposited = Number(data.deposited);
      if(typeof data.poolBalance !== 'undefined') poolBalance = Number(data.poolBalance);
      updateBalancesUI();
      document.getElementById('depositAmount').value = '';
      msg.innerText = 'Deposit submitted successfully.';
      // optionally refresh public transactions if deposit is published
      refreshPublicTransactions();
    } catch (e) {
      console.error(e);
      msg.innerText = 'Network error while submitting deposit.';
    }
  }
  function clearDeposit(){ document.getElementById('depositAmount').value = ''; document.getElementById('depositMessage').innerText = ''; }

  // ---------------- Withdraw flow ----------------
  async function submitWithdraw(){
    const amount = Number(document.getElementById('withdrawAmount').value || 0);
    const msg = document.getElementById('withdrawMessage');
    msg.innerText = '';

    if(!amount || amount <= 0){
      msg.innerText = 'Please enter a valid withdraw amount.';
      return;
    }

    // compute allowed limit
    const limit = computeWithdrawLimit();

    // if(amount > limit){
    //   // treat as loan: block withdraw and offer to pre-fill loan form
    //   msg.innerText = `Requested amount exceeds your withdraw limit (${formatINR(limit)}). This would be considered a loan. Please submit a loan request instead.`;
    //   // prefill loan form
    //   document.getElementById('loanAmount').value = amount;
    //   document.getElementById('loanReason').focus();
    //   return;
    // }

    // proceed to call withdraw endpoint
    const form = new FormData();
    form.append('user', 'hi');
    form.append('amt', amount);

    try {
      const res = await fetch(ENDPOINTS.withdraw, {
        method: 'POST',
        credentials: 'include',
        body: form
      });

      if(!res.ok){
        const text = await res.text();
        msg.innerText = 'Withdraw failed: ' + (text || res.status);
        return;
      }

      const data = await res.json();
      // Expect backend to return updated deposited & pool balance, or at least success.
      if(typeof data.deposited !== 'undefined') yourDeposited = Number(data.deposited);
      if(typeof data.poolBalance !== 'undefined') poolBalance = Number(data.poolBalance);
      updateBalancesUI();
      document.getElementById('withdrawAmount').value = '';
      msg.innerText = 'Withdraw submitted successfully.';
      refreshPublicTransactions();
    } catch (e) {
      console.error(e);
      msg.innerText = 'Network error while submitting withdraw.';
    }
  }
  function clearWithdraw(){ document.getElementById('withdrawAmount').value = ''; document.getElementById('withdrawMessage').innerText = ''; }

  // ---------------- Loan request (private) ----------------
  async function submitLoan(){
    const amount = Number(document.getElementById('loanAmount').value || 0);
    const reason = (document.getElementById('loanReason').value || '').trim();
    const docsEl = document.getElementById('loanDocs');
    const messageEl = document.getElementById('loanMessage');

    messageEl.innerText = '';

    if(!amount || amount <= 0){
      messageEl.innerText = 'Enter a valid loan amount.';
      return;
    }
    if(reason.length < 10){
      messageEl.innerText = 'Please provide a clear reason (at least 10 characters).';
      return;
    }

    const form = new FormData();
    form.append('amount', amount);
    form.append('reason', reason);
    if(docsEl.files && docsEl.files.length > 0) form.append('document', docsEl.files[0]);

    try {
      const res = await fetch(ENDPOINTS.submitLoan, {
        method: 'POST',
        credentials: 'include',
        body: form
      });

      if(!res.ok){
        const text = await res.text();
        messageEl.innerText = 'Failed to submit loan request: ' + (text || res.status);
        return;
      }

      const resp = await res.json();
      messageEl.innerText = 'Loan request submitted. Status: ' + (resp.status || 'pending');
      clearLoanForm();
    } catch (e) {
      console.error(e);
      messageEl.innerText = 'Network error while submitting loan request.';
    }
  }
  function clearLoanForm(){ document.getElementById('loanAmount').value=''; document.getElementById('loanReason').value=''; document.getElementById('loanDocs').value=''; document.getElementById('loanMessage').innerText=''; }

  // ---------------- Navigation helpers ----------------
  function goToBlockchain(){ window.location.href = 'admin_dashboard.html'; }
  function logout(){ if(confirm('Logout and go back to login?')) window.location.href = 'lP.html'; }

  // ---------------- Initialize page ----------------
  (function init(){
    // Fetch dashboard (deposited & pool balances) if available
    fetchDashboard();
    // Load public transactions
    refreshPublicTransactions();
  })();

</script>

</body>
</html>
